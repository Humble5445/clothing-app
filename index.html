import React, { useState, useMemo, useEffect } from "react";

// 提示：这个文件使用 **非 JSX** 的写法（React.createElement）以避免运行时需要 babel 动态编译，
// 从而修复在某些沙盒环境中出现的 “Failed to fetch dynamically imported module: babel-*.js” 错误。
// 功能：更多款式/颜色、按天气过滤、保存/载入、生成分享链接、导出图片（需 html2canvas）

export default function WakeupOutfitAssistant() {
  const e = React.createElement;

  // --- 数据 ---
  const topStyles = [
    { id: "tee", name: "T 恤 / Tee", colors: ["白", "黑", "蓝", "灰", "条纹"] },
    { id: "shirt", name: "衬衫 / Shirt", colors: ["白", "蓝", "条纹", "粉", "格纹"] },
    { id: "sweater", name: "毛衣 / Sweater", colors: ["灰", "米", "蓝", "绿", "酒红"] },
    { id: "hoodie", name: "卫衣 / Hoodie", colors: ["黑", "军绿", "灰", "酒红", "蓝"] },
    { id: "tank", name: "背心 / Tank", colors: ["白", "黑", "棕"] },
    { id: "blouse", name: "女式衬衫 / Blouse", colors: ["白", "粉", "米", "花色"] },
  ];

  const pantsStyles = [
    { id: "jeans", name: "牛仔裤 / Jeans", colors: ["浅蓝", "深蓝", "黑"] },
    { id: "chinos", name: "休闲裤 / Chinos", colors: ["卡其", "灰", "黑", "深绿"] },
    { id: "shorts", name: "短裤 / Shorts", colors: ["黑", "卡其", "军绿", "牛仔蓝"] },
    { id: "sweatpants", name: "运动裤 / Sweatpants", colors: ["灰", "黑", "深蓝"] },
    { id: "skirt", name: "半身裙 / Skirt", colors: ["黑", "灰", "碎花"] },
  ];

  const socksOptions = [
    { id: "white_low", name: "白色短袜", type: "短袜", colors: ["白"] },
    { id: "black_low", name: "黑色短袜", type: "短袜", colors: ["黑"] },
    { id: "neutral_mid", name: "中筒袜（中性）", type: "中筒", colors: ["灰", "黑", "白"] },
    { id: "patterned", name: "花纹袜", type: "花纹", colors: ["多色"] },
    { id: "no_show", name: "隐形袜", type: "隐形", colors: ["肤色", "白"] },
  ];

  const compatibility = {
    tee: { pants: ["jeans", "chinos", "shorts"], socks: ["white_low", "black_low", "no_show", "neutral_mid"] },
    shirt: { pants: ["chinos", "jeans", "skirt"], socks: ["neutral_mid", "patterned", "white_low"] },
    sweater: { pants: ["jeans", "chinos", "sweatpants"], socks: ["neutral_mid", "patterned"] },
    hoodie: { pants: ["jeans", "sweatpants", "shorts"], socks: ["black_low", "neutral_mid"] },
    tank: { pants: ["shorts", "jeans", "skirt"], socks: ["no_show", "white_low"] },
    blouse: { pants: ["skirt", "chinos", "jeans"], socks: ["patterned", "neutral_mid"] },
  };

  // --- state ---
  const [selectedTopStyle, setSelectedTopStyle] = useState(null);
  const [selectedTopColor, setSelectedTopColor] = useState(null);
  const [selectedPantsStyle, setSelectedPantsStyle] = useState(null);
  const [selectedPantsColor, setSelectedPantsColor] = useState(null);
  const [selectedSocks, setSelectedSocks] = useState(null);
  const [weather, setWeather] = useState(null);
  const [season, setSeason] = useState(null);
  const [saved, setSaved] = useState(() => {
    try { return JSON.parse(localStorage.getItem('outfits_v2') || '[]'); } catch { return []; }
  });

  // --- derived ---
  const availableTopColors = useMemo(() => {
    if (!selectedTopStyle) return [];
    const s = topStyles.find(t => t.id === selectedTopStyle);
    return s ? s.colors : [];
  }, [selectedTopStyle]);

  const availablePants = useMemo(() => {
    if (!selectedTopStyle) return pantsStyles;
    const allowed = compatibility[selectedTopStyle]?.pants || [];
    return pantsStyles.filter(p => allowed.length === 0 || allowed.includes(p.id));
  }, [selectedTopStyle]);

  const availablePantsColors = useMemo(() => {
    if (!selectedPantsStyle) return [];
    const s = pantsStyles.find(p => p.id === selectedPantsStyle);
    return s ? s.colors : [];
  }, [selectedPantsStyle]);

  const availableSocks = useMemo(() => {
    let byTop = selectedTopStyle ? (compatibility[selectedTopStyle]?.socks || socksOptions.map(s => s.id)) : socksOptions.map(s => s.id);
    if (!selectedTopStyle) byTop = socksOptions.map(s => s.id);

    const byPants = (() => {
      if (!selectedPantsStyle) return socksOptions.map(s => s.id);
      if (selectedPantsStyle === 'shorts') return ["white_low", "black_low", "patterned", "no_show"];
      if (selectedPantsStyle === 'sweatpants') return ["black_low", "neutral_mid"];
      return socksOptions.map(s => s.id);
    })();

    return socksOptions.filter(s => byTop.includes(s.id) && byPants.includes(s.id));
  }, [selectedTopStyle, selectedPantsStyle]);

  // weather filter
  function filterByWeather(items, type) {
    if (!weather) return items;
    const t = weather.temp;
    if (t >= 28) {
      if (type === 'top') return items.filter(i => !['sweater','hoodie'].includes(i.id));
      if (type === 'pants') return items.filter(i => !['sweatpants'].includes(i.id));
    }
    if (t <= 10) {
      if (type === 'top') return items.filter(i => !['tank','tee','blouse'].includes(i.id));
      return items;
    }
    return items;
  }

  const availableTopStyles = useMemo(() => filterByWeather(topStyles, 'top'), [weather]);
  const filteredPants = useMemo(() => filterByWeather(availablePants, 'pants'), [availablePants, weather]);

  // --- actions ---
  function chooseTopStyle(id) {
    setSelectedTopStyle(id);
    setSelectedTopColor(null);
    setSelectedPantsStyle(null);
    setSelectedPantsColor(null);
    setSelectedSocks(null);
  }
  function chooseTopColor(c) {
    setSelectedTopColor(c);
    setSelectedPantsStyle(null);
    setSelectedPantsColor(null);
    setSelectedSocks(null);
  }
  function choosePantsStyle(id) {
    setSelectedPantsStyle(id);
    setSelectedPantsColor(null);
    setSelectedSocks(null);
  }
  function choosePantsColor(c) {
    setSelectedPantsColor(c);
    setSelectedSocks(null);
  }
  function chooseSocks(id) {
    setSelectedSocks(id);
  }

  function clearAll() {
    setSelectedTopStyle(null);
    setSelectedTopColor(null);
    setSelectedPantsStyle(null);
    setSelectedPantsColor(null);
    setSelectedSocks(null);
  }

  function randomizeAll() {
    const topsPool = (availableTopStyles && availableTopStyles.length) ? availableTopStyles : topStyles;
    const top = topsPool[Math.floor(Math.random() * topsPool.length)];
    const topColor = top.colors[Math.floor(Math.random() * top.colors.length)];
    const pantsPool = (compatibility[top.id]?.pants || pantsStyles.map(p => p.id)).map(pid => pantsStyles.find(p => p.id === pid)).filter(Boolean);
    const pants = pantsPool[Math.floor(Math.random() * pantsPool.length)];
    const pantsColor = pants.colors[Math.floor(Math.random() * pants.colors.length)];
    const socksPool = (compatibility[top.id]?.socks || socksOptions.map(s => s.id)).filter(s => {
      if (!pants) return true;
      if (pants.id === 'shorts') return ["white_low","black_low","patterned","no_show"].includes(s);
      return true;
    });
    const socks = socksPool[Math.floor(Math.random() * socksPool.length)];

    setSelectedTopStyle(top.id);
    setSelectedTopColor(topColor);
    setSelectedPantsStyle(pants.id);
    setSelectedPantsColor(pantsColor);
    setSelectedSocks(socks);
  }

  function saveOutfit(name) {
    const item = {
      id: Date.now(),
      name: name || `搭配 ${new Date().toLocaleString()}`,
      topStyle: selectedTopStyle,
      topColor: selectedTopColor,
      pantsStyle: selectedPantsStyle,
      pantsColor: selectedPantsColor,
      socks: selectedSocks,
      weather,
      season,
    };
    const newSaved = [item, ...saved].slice(0, 50);
    setSaved(newSaved);
    try { localStorage.setItem('outfits_v2', JSON.stringify(newSaved)); } catch(e) { console.error(e); }
  }

  function deleteSaved(id) {
    const newSaved = saved.filter(s => s.id !== id);
    setSaved(newSaved);
    try { localStorage.setItem('outfits_v2', JSON.stringify(newSaved)); } catch(e) { console.error(e); }
  }

  function getShareUrl() {
    try {
      const params = new URLSearchParams();
      if (selectedTopStyle) params.set('top', selectedTopStyle);
      if (selectedTopColor) params.set('topColor', selectedTopColor);
      if (selectedPantsStyle) params.set('pants', selectedPantsStyle);
      if (selectedPantsColor) params.set('pantsColor', selectedPantsColor);
      if (selectedSocks) params.set('socks', selectedSocks);
      if (season) params.set('season', season);
      return `${location.origin}${location.pathname}?${params.toString()}`;
    } catch (e) { return window.location.href; }
  }

  async function exportAsImage() {
    const node = document.getElementById('preview-card');
    if (!node) return alert('找不到预览卡片');
    if (!window.html2canvas) return alert('图片导出需要 html2canvas 库（在页面中引入）');
    try {
      const canvas = await window.html2canvas(node, { scale: 2 });
      const dataUrl = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = 'outfit.png';
      a.click();
    } catch (e) { alert('导出失败'); console.error(e); }
  }

  // Load from URL params on mount
  useEffect(() => {
    try {
      const p = new URLSearchParams(location.search);
      if (p.get('top')) setSelectedTopStyle(p.get('top'));
      if (p.get('topColor')) setSelectedTopColor(p.get('topColor'));
      if (p.get('pants')) setSelectedPantsStyle(p.get('pants'));
      if (p.get('pantsColor')) setSelectedPantsColor(p.get('pantsColor'));
      if (p.get('socks')) setSelectedSocks(p.get('socks'));
      if (p.get('season')) setSeason(p.get('season'));
    } catch(e){/* ignore */}
  }, []);

  // Weather: try to fetch OpenWeather (replace key when you want to enable)
  useEffect(() => {
    const KEY = 'REPLACE_WITH_YOUR_OPENWEATHER_API_KEY';
    if (!KEY || KEY.startsWith('REPLACE')) return;
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      try {
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${KEY}&units=metric`);
        const data = await res.json();
        if (data && data.main) {
          setWeather({ temp: data.main.temp, desc: data.weather?.[0]?.main || '' });
          const m = new Date().getMonth() + 1;
          if ([12,1,2].includes(m)) setSeason('winter');
          else if ([3,4,5].includes(m)) setSeason('spring');
          else if ([6,7,8].includes(m)) setSeason('summer');
          else setSeason('autumn');
        }
      } catch(e) { console.error(e); }
    }, (err) => { /* ignore geo errors */ });
  }, []);

  // helper
  const getNameById = (list, id) => (list.find(x => x.id === id) || {}).name || id || '-';

  // --- render helpers (use e = React.createElement) ---
  const renderTopButtons = () => availableTopStyles.map(t => e('button', {
    key: t.id,
    onClick: () => chooseTopStyle(t.id),
    className: 'px-3 py-2 rounded-lg border flex items-center gap-3 ' + (selectedTopStyle === t.id ? 'bg-sky-600 text-white' : 'bg-white')
  },
    e('svg', { width: 36, height: 36, viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' },
      e('rect', { width: 24, height: 24, rx: 4, fill: '#E6EEF9' }),
      e('path', { d: 'M6 7c0 1.5 2 2 6 2s6-.5 6-2', stroke: '#0F172A', strokeWidth: 1.2, strokeLinecap: 'round', strokeLinejoin: 'round', fill: 'none' })
    ),
    e('div', { className: 'text-sm' }, t.name)
  ));

  const renderTopColors = () => (availableTopColors.length === 0 ? [e('div', { key: 'hint', className: 'text-xs text-slate-400' }, '先选择款式')] : availableTopColors.map(c => e('button', {
    key: c,
    onClick: () => chooseTopColor(c),
    className: 'px-3 py-1 rounded-md border ' + (selectedTopColor === c ? 'ring-2 ring-sky-300' : '')
  }, c)));

  const renderPantsButtons = () => filteredPants.map(p => e('button', {
    key: p.id,
    onClick: () => choosePantsStyle(p.id),
    className: 'px-3 py-2 rounded-lg border flex items-center gap-3 ' + (selectedPantsStyle === p.id ? 'bg-amber-500 text-white' : '')
  }, e('svg', { width: 36, height: 36, viewBox: '0 0 24 24' }, e('rect', { width: 24, height: 24, rx: 4, fill: '#FFFAEB' })), e('div', { className: 'text-sm' }, p.name)));

  const renderPantsColors = () => (availablePantsColors.length === 0 ? [e('div', { key: 'hint2', className: 'text-xs text-slate-400' }, '先选择裤子款式')] : availablePantsColors.map(c => e('button', {
    key: c,
    onClick: () => choosePantsColor(c),
    className: 'px-3 py-1 rounded-md border ' + (selectedPantsColor === c ? 'ring-2 ring-amber-300' : '')
  }, c)));

  const renderSocks = () => availableSocks.map(s => e('label', {
    key: s.id,
    className: 'flex items-center gap-3 p-2 rounded-md border ' + (selectedSocks === s.id ? 'bg-green-600 text-white' : 'bg-white')
  }, e('input', { type: 'radio', name: 'socks', checked: selectedSocks === s.id, onChange: () => chooseSocks(s.id) }), e('div', { className: 'text-sm' }, s.name)));

  const renderSaved = () => (saved.length === 0 ? [e('div', { key: 'no', className: 'text-xs text-slate-400' }, '暂无已保存搭配')] : saved.map(s => e('div', { key: s.id, className: 'flex items-center gap-3 p-2 border rounded' }, e('div', { className: 'flex-1 text-sm' }, s.name, e('div', { className: 'text-xs text-slate-400' }, (s.topColor||'-') + ' ' + (s.topStyle||'-') + ' + ' + (s.pantsColor||'-') + ' ' + (s.pantsStyle||'-'))), e('button', { onClick: () => { setSelectedTopStyle(s.topStyle); setSelectedTopColor(s.topColor); setSelectedPantsStyle(s.pantsStyle); setSelectedPantsColor(s.pantsColor); setSelectedSocks(s.socks); }, className: 'px-2 py-1 rounded border text-sm' }, '载入'), e('button', { onClick: () => deleteSaved(s.id), className: 'px-2 py-1 rounded border text-sm' }, '删除'))));

  // top-level container
  return e('div', { className: 'min-h-screen bg-gradient-to-b from-white to-slate-50 p-6 flex flex-col items-center' },
    e('div', { className: 'w-full max-w-5xl bg-white/90 shadow-lg rounded-2xl p-6' },
      e('header', { className: 'flex items-center justify-between mb-4' },
        e('h1', { className: 'text-2xl font-semibold' }, '起床穿搭小助手（修复版）'),
        e('div', { className: 'text-sm text-slate-600' }, '自动天气过滤 · 保存搭配 · 导出图片 · 分享链接')
      ),

      e('main', { className: 'grid grid-cols-1 lg:grid-cols-4 gap-4' },
        // Selection column
        e('section', { className: 'lg:col-span-2 p-4 border rounded-lg' },
          e('div', { className: 'flex gap-3 items-center mb-3' },
            e('div', { className: 'text-sm text-slate-500' }, '天气:'),
            e('div', { className: 'font-medium' }, weather ? `${weather.temp}°C · ${weather.desc}` : '未获取（需设置API并允许定位）'),
            e('div', { className: 'ml-auto text-xs text-slate-400' }, '季节: ' + (season || '-'))
          ),

          e('div', { className: 'space-y-4' },
            e('div', null,
              e('div', { className: 'text-sm text-slate-500 mb-2' }, '上衣（款式）'),
              e('div', { className: 'flex flex-wrap gap-2' }, ...renderTopButtons()),
              e('div', { className: 'mt-3 text-sm text-slate-500 mb-2' }, '上衣（颜色）'),
              e('div', { className: 'flex flex-wrap gap-2' }, ...renderTopColors())
            ),

            e('div', null,
              e('div', { className: 'text-sm text-slate-500 mb-2' }, '裤子（款式）'),
              e('div', { className: 'flex flex-wrap gap-2' }, ...renderPantsButtons()),
              e('div', { className: 'mt-3 text-sm text-slate-500 mb-2' }, '裤子（颜色）'),
              e('div', { className: 'flex flex-wrap gap-2' }, ...renderPantsColors())
            ),

            e('div', null,
              e('div', { className: 'text-sm text-slate-500 mb-2' }, '袜子（推荐）'),
              e('div', { className: 'flex flex-wrap gap-2' }, ...renderSocks())
            )
          ),

          e('div', { className: 'mt-4 flex gap-2' },
            e('button', { onClick: randomizeAll, className: 'px-4 py-2 rounded bg-sky-600 text-white' }, '随机搭配'),
            e('button', { onClick: clearAll, className: 'px-4 py-2 rounded border' }, '清除'),
            e('button', { onClick: () => { const name = prompt('保存为（名称）：'); if (name !== null) saveOutfit(name); }, className: 'px-4 py-2 rounded bg-amber-500 text-white' }, '保存搭配'),
            e('button', { onClick: () => { try { navigator.clipboard.writeText(getShareUrl()); alert('已复制分享链接'); } catch(e){ alert('复制失败：'+getShareUrl()); } }, className: 'px-4 py-2 rounded border' }, '复制分享链接')
          ),

          e('div', { className: 'mt-3 text-xs text-slate-400' }, '提示：可到代码顶部把 REPLACE_WITH_YOUR_OPENWEATHER_API_KEY 替换为你的 OpenWeather API Key 并允许定位，即可自动按天气筛选（需要联网）。')
        ),

        // Preview & actions
        e('section', { className: 'lg:col-span-2 p-4 border rounded-lg flex flex-col gap-3' },
          e('div', { id: 'preview-card', className: 'p-4 rounded-lg border bg-white' },
            e('div', { className: 'flex items-center gap-4' },
              e('div', { className: 'w-32 h-32 bg-gray-50 rounded flex items-center justify-center' },
                e('svg', { width: 80, height: 80, viewBox: '0 0 24 24' }, e('circle', { cx: 12, cy: 7, r: 3, fill: '#CBD5E1' }), e('path', { d: 'M5 21c1.5-3 4.5-5 7-5s5.5 2 7 5', stroke: '#94A3B8', strokeWidth: 1.2, fill: 'none' }))
              ),
              e('div', null,
                e('div', { className: 'text-sm text-slate-500' }, '完整搭配'),
                e('div', { className: 'text-lg font-semibold' }, (selectedTopColor || '-') + ' ' + (selectedTopStyle ? getNameById(topStyles, selectedTopStyle) : '-') + ' + ' + (selectedPantsColor || '-') + ' ' + (selectedPantsStyle ? getNameById(pantsStyles, selectedPantsStyle) : '-') + ' + ' + (selectedSocks ? getNameById(socksOptions, selectedSocks) : '-')),
                e('div', { className: 'text-xs text-slate-400 mt-1' }, '季节: ' + (season || '未设置'))
              )
            ),

            e('div', { className: 'mt-4 grid grid-cols-3 gap-3' },
              e('div', { className: 'p-3 border rounded text-center' }, e('div', { className: 'text-xs text-slate-500' }, '上衣'), e('div', { className: 'font-medium mt-1' }, selectedTopStyle ? getNameById(topStyles, selectedTopStyle) : '-'), e('div', { className: 'text-xs text-slate-400' }, selectedTopColor || '-')),
              e('div', { className: 'p-3 border rounded text-center' }, e('div', { className: 'text-xs text-slate-500' }, '裤子'), e('div', { className: 'font-medium mt-1' }, selectedPantsStyle ? getNameById(pantsStyles, selectedPantsStyle) : '-'), e('div', { className: 'text-xs text-slate-400' }, selectedPantsColor || '-')),
              e('div', { className: 'p-3 border rounded text-center' }, e('div', { className: 'text-xs text-slate-500' }, '袜子'), e('div', { className: 'font-medium mt-1' }, selectedSocks ? getNameById(socksOptions, selectedSocks) : '-'))
            )
          ),

          e('div', { className: 'flex gap-2' },
            e('button', { onClick: exportAsImage, className: 'px-4 py-2 rounded bg-green-600 text-white' }, '导出为图片'),
            e('button', { onClick: () => { const url = getShareUrl(); window.open(url, '_blank'); }, className: 'px-4 py-2 rounded border' }, '打开分享链接')
          ),

          e('div', null, e('h4', { className: 'font-medium' }, '已保存的搭配'), e('div', { className: 'mt-2 space-y-2 max-h-48 overflow-auto' }, ...renderSaved()))
        )
      ),

      e('footer', { className: 'mt-4 text-xs text-slate-400' }, '说明：若要启用天气自动过滤，请在代码顶部把 REPLACE_WITH_YOUR_OPENWEATHER_API_KEY 替换为你的 OpenWeather API Key 并允许浏览器定位。')
    ),
    e('div', { className: 'mt-3 text-xs text-slate-400' }, '需要我把这个打包成单个 HTML 文件供你下载吗？我可以生成并提供下载链接。')
  );
}
